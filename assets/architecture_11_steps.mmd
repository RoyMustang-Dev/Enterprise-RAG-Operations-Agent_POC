graph TD
    %% Global Styling
    classDef input fill:#e1f5fe,stroke:#0288d1,stroke-width:2px;
    classDef core fill:#e8f5e9,stroke:#388e3c,stroke-width:2px;
    classDef agent fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;
    classDef storage fill:#fff3e0,stroke:#f57c00,stroke-width:2px;
    classDef verify fill:#ffebee,stroke:#c62828,stroke-width:2px;
    classDef highlight fill:#e8eaf6,stroke:#3f51b5,stroke-width:3px;

    %% 1. Guard
    User((User Input)) --> Guard{1. Prompt Guard<br/>llama-prompt-guard}
    class User input;
    class Guard verify;

    %% 2. Rewriter & SQLite
    Guard -->|Safe| Rewriter[2. Prompt Rewriter<br/>gpt-oss-120b]
    Guard -->|Malicious| Reject((Block))
    DB[(SQLite Multi-Turn<br/>Chat History)] -.-> |"Context Provide"| Rewriter
    class Rewriter agent;
    class DB storage;

    %% 3. Adaptive Planner (New)
    Rewriter --> Planner{3. Adaptive Planner<br/>Dynamic Decision}
    class Planner core;

    %% 4. Parallel Intent & Complexity
    Planner --> Intent[4a. Intent Supervisor<br/>llama-3.1-8b]
    Planner --> Complexity[4b. Complexity Analyzer<br/>Heuristic Scoring]
    class Intent,Complexity core;
    
    Intent -->|Smalltalk| Bypass[5. Bypass Responder]
    Intent -->|Code/Analytics| Coder[5. MoE Coder<br/>qwen3-32b]
    class Bypass,Coder agent;

    %% 6. Metadata
    Intent -->|RAG Query| Metadata[6. Metadata Extractor<br/>llama-3.1-8b]
    class Metadata agent;

    %% 7. Retrieval & 8. Rerank
    Metadata --> VectorDB[(7. Qdrant Search<br/>Top 30 Chunks)]
    class VectorDB storage;
    
    VectorDB --> Rerank{8. Cross-Encoder<br/>Rerank Top 5 (Sigmoid)}
    class Rerank core;

    %% 9. Synthesis
    Complexity -->|Model Route| Synth[9. Adaptive Synthesis<br/>llama-70b OR gpt-120b]
    Rerank --> Synth
    class Synth highlight;

    %% 10. Verifier
    Synth --> Verifier{10. Fact Verifier<br/>Sarvam M}
    Verifier -.->|Hallucination Detected<br/>(Correction Loop)| Synth
    class Verifier verify;

    %% 11. Formatter & 12. Telemetry
    Verifier -->|Verified Text| Formatter[11. Markup Formatter]
    Formatter --> Telemetry[(12. Telemetry & RLHF<br/>audit_logs.jsonl)]
    class Formatter agent;
    class Telemetry storage;
    
    Telemetry --> Output((Final JSON Output))
    class Output input;
